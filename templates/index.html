<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Mirror</title>
    <link href="{{ url_for('static', filename='css/main.css') }}"
          rel="stylesheet" type="text/css">
    <link href="{{ url_for('static', filename='css/weather-icons.css') }}"
          rel="stylesheet" type="text/css">
    <link href='https://fonts.googleapis.com/css?family=Roboto:400,300,700'
          rel='stylesheet' type='text/css'>
</head>
<body>
<div id="content">
    <div id="weather">
        <div class="large">
            <i id="weather_icon"></i>
            <span id="weather_temp"></span>°
        </div>
        <div>
            <span id="weather_summary"></span>
        </div>
        <table class="small"> <!-- 5 columns wide -->
            <tr>
                <td colspan="5">Feels like <span id="weather_feels"></span>°</td>
            </tr>
            <tr>
                <td colspan="5">
                    <i class="wi wi-strong-wind"></i>
                    <span id="weather_wind"></span><sup class="tiny">mph</sup>
                </td>
            </tr>
            <tr>
                <td colspan="5">
                    <i class="wi wi-sunrise"></i>
                    <span id="weather_sunrise">sunrise</span>
                </td>
            </tr>
            <tr>
                <td colspan="5">
                    <i class="wi wi-sunset"></i>
                    <span id="weather_sunset">sunset</span>
                </td>
            </tr>
            <tr><td colspan="4">&nbsp;</td></tr>
            <tr id="forecast_0">
                <td></td>
            </tr>
            <tr id="forecast_1">
                <td></td>
            </tr>
            <tr id="forecast_2">
                <td></td>
            </tr>
            <tr id="forecast_3">
                <td></td>
            </tr>
            <tr id="forecast_4">
                <td></td>
            </tr>
        </table>
    </div>
    <div id="datetime">
        <span id="time" class="large"></span><br>
        <span id="date"></span>
    </div>
    <div id="agenda">
        <br>
        <table id="agenda_items" class="small">
        </table>
    </div>
</div>
<script src="{{ url_for('static', filename='js/jquery-2.2.0.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/moment.min.js') }}"></script>
<script language="JavaScript">
    $(document).ready(function() {
        updateTime();
        setInterval(updateTime, 1 * 1000);
        updateWeather();
        setInterval(updateWeather, 60 * 1000);
        updateForecast();
        setInterval(updateForecast, 60 * 60 * 1000);
        updateAgenda();
        setInterval(updateAgenda, 2 * 60 * 1000);
    });

    function updateTime() {
        var now = moment();
        $("#time").html(now.format("h:mm a"));
        $("#date").html(now.format("dddd, MMMM Do YYYY"));
    }

    function updateWeather() {
        $.getJSON("/weather", function(json) {
            $("#weather_icon").removeClass();
            $("#weather_icon").addClass('large ' + iconClass(json.icon));
            $("#weather_temp").html(Math.round(json.temperature));
            $("#weather_summary").html(json.summary);
            $("#weather_feels").html(Math.round(json.apparentTemperature));
            $("#weather_wind").html(Math.round(json.windSpeed));
        });
    }

    function updateForecast() {
        $.getJSON("/forecast", function(json) {
            var limit = Math.min(5, json.data.length);
            var today = json.data[0];
            var sunrise = moment.unix(today.sunriseTime).local();
            $("#weather_sunrise").html(sunrise.format("h:mm a"));
            var sunset = moment.unix(today.sunsetTime).local();
            $("#weather_sunset").html(sunset.format("h:mm a"));
            $("#forecast_0").html(
                "<td>Today</td>" +
                forecastCells(today)
            );
            for (var i = 1; i < limit; i++) {
                var day = json.data[i];
                var date = moment.unix(day.time).local();
                $("#forecast_" + i).html(
                    "<td>" + date.format("ddd") + "</td>" +
                    forecastCells(day)
                );
            }
        });
    }

    function forecastCells(day) {
        var rain = Math.round(day.precipProbability * 100);
        return (
            "<td><i class='" + iconClass(day.icon) + "'></i></td>" +
            "<td>↑ <b>" + Math.round(day.temperatureMax) + "°</b></td>" +
            "<td>↓ " + Math.round(day.temperatureMin) + "°</td>" +
            "<td><i class='wi wi-umbrella'></i> " + rain +
            "<sup class='tiny'>%</sup></td>"
         );
    }

    function iconClass(icon) {
        return 'wi wi-forecast-io-' + icon;
    }

    function updateAgenda() {
        $.getJSON("/agenda", function(json) {
            var rows = "";
            for (var i = 0; i < json.items.length; i++) {
                var row = "<tr>";
                var item = json.items[i];
                if ('dateTime' in item.start) {
                    var start = moment(item.start.dateTime);
                    row += "<td>" + start.format("h:mm a") + "</td>";
                } else {
                    // all day event
                    row += "<td>All Day -</td>";
                }
                row += "<td>" + item.summary + "</td>";
                rows += row;
            }
            if (json.items.length == 0) {
                rows += "<tr><td colspan='2'>Nothing more today</td></tr>";
            }
            $("#agenda_items").html(rows);
        });
    }
</script>
</body>
</html>
